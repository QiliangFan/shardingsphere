#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: ISSUE Standardized Process

on:
  schedule:
    - cron: '0 0 */1 * *'  # once a day

  issue_comment:
    types: [created]

  issues:
    types: [labeled]
  

jobs:
  comment-action:
    runs-on: ubuntu-latest
    steps:
      - name: Print Issue Comment
        run: |
          echo ${{ github.event.comment.body }}

      - name: Trigger The CI Workflow
        if: contains( github.event.comment.body , '/run ci') 
        uses: mvasigh/dispatch-action@main
        with:
          token: ${{ secrets.PERSONAL_TOKEN }}
          repo: shardingsphere
          owner: ${{ github.actor }}
          event_type: rerun-ci

      # if a new reply is received, remove `type:inactive` label
      - name: Remove `type:inactive` label
        if: ${{ always() }}
        uses: actions-cool/issues-helper@v2.2.1
        with:
          actions: 'remove-labels'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          labels: "type:inactive"

  
  check-inactive-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Create label  # create label if not exist
        uses: actions-cool/issues-helper@v2.2.1
        with:
          actions: "create-label"
          label-name: "type:inactive"
          label-color: "778899"
          label-desc: "the issues without replies in several days"

      - name: check-inactive   # add `type:inactive` label
        uses: actions-cool/issues-helper@v2.2.1 
        with: 
          actions: 'check-inactive' 
          token: ${{ secrets.GITHUB_TOKEN }} 
          inactive-day: 15
          inactive-label: "type:inactive"
          body: |
            Hello ${{ github.event.issue.user.login }}, this issue has not received a reply for serveral days.
            This issue is supposed to be closed.
          contents: "heart"
  

  close-issue:
    runs-on: ubuntu-latest
    concurrency: close-issue   # singleton-run-stage

    steps:
      - name: Close Issue   # close issues with `labels`
        uses: actions-cool/issues-helper@v2.2.1
        with:
          actions: 'close-issues'
          token: ${{ secrets.GITHUB_TOKEN }}
          labels: 'type:inactive'